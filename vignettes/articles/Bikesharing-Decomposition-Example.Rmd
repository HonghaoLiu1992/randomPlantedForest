---
title: "Bikesharing: Decomposition Example"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.width = 9
)

# Adapted from https://github.com/PlantedML/shap_decomposition/blob/master/bike_example/bike_example.R
```

```{r setup}
library(randomPlantedForest)
library(ISLR2) # For Bikeshare dataset
library(data.table) # Some post-processing required!
library(ggplot2)
library(patchwork) # To arrange plots
set.seed(2023)

theme_set(theme_minimal(base_size = 13))
```

## Preparing the Data

First we load the `Bikeshare` data from the `ISLR2` package, which provides the dataset published at the [UCI Machine Learning Repository](https://archive.ics.uci.edu/ml/datasets/bike+sharing+dataset).

> This data set contains the hourly and daily count of rental bikes between years 2011 and 2012 in Capital bikeshare system, along with weather and seasonal information.

The outcome is going to be `bikers`, the total number of bikers in the system.

The predictors of interest in our case are going to be the following:

- `hr`: Hour of day, 0 to 23 hours.
- `temp`: Normalized temperature in Celsius
- `workingday`: Binary value indicating whether it's a work day (1) or not (0)

We recode the `hr` column from a 24-level `factor` to a numeric column.

```{r data-prep}
data(Bikeshare)
bike <- data.table(Bikeshare)
bike[, hr := as.numeric(as.character(hr))]
bike[, workingday := factor(workingday, labels = c("No Workingday", "Workingday"))]

head(bike)
```


## Fitting, Purification, Component Extraction

Next we can fit a Random Planted Forest on the `bikers` variable, using a subset of the available predictors.
We limit the model's complexity by setting `max_interaction = 3`, as we are only going to visualize interactions up to the third degree, and using a higher value here might only marginally improve predictive performance at the cost of a longer runtime.
For our example here, a smaller model with merely 20 trees suffices.
We also `purify` the forest to enable the desired decomposition.
This step is not required for global predictions and may take some time, which is why it is implemented as a separate step.

```{r model-fit}
rp <- rpf(
  bikers ~ day + hr + temp + windspeed + workingday + hum,
  data = bike,
  max_interaction = 3, ntrees = 20
)

purify(rp)
```

We select the predictors of interest and use `extract_components()` to retrieve all predictive components that include them,
from main effects to 3rd degree interactions.
We also create an auxiliary table in long format which includes the observed predictor values, which we use for the plot of the main effects.


```{r extract-components}
vars <- c("hr", "temp", "workingday")

components <- extract_components(rp, bike, predictors = vars)
components$m
```

## Main Effects

```{r main-effects}
p_main <- plot_main_effect(components, "temp") +
  plot_main_effect(components, "hr") +
  plot_main_effect(components, "workingday") +
  plot_layout(nrow = 1) +
  plot_annotation(tag_levels = "1", tag_prefix = "m")

p_main
```

## 2-Way Interactions

```{r twoway-effects}
p_2way <- (
    plot_twoway_effects(components, c("workingday", "temp")) /
    plot_twoway_effects(components, c("hr", "workingday")) + 
    plot_layout(guides = "collect") &
      theme(legend.position = "bottom")
  ) |
  plot_twoway_effects(components, c("hr", "temp"))

p_2way <- p_2way + 
  plot_annotation(tag_levels = list(c("1,1", "3,2", "3,1")), tag_prefix = "m")

p_2way
```

# 3-Way Interaction

```{r threeway-effects, eval = FALSE}
int3way <- data.frame(
  hr = bike[["hr"]], 
  temp = bike[["temp"]],
  workingday = bike[["workingday"]],
  m = components[["hr:temp:workingday"]]
)

p_3way <- ggplot(int3way, aes(x = hr, y = temp, color = m)) +
  facet_wrap(vars(workingday)) +
  geom_point() +
  scale_color_viridis_c() +
  labs(
    y = expression(atop(3 - way ~ interactions ~ italic(m[jkl]), "temp")),
    color = expression(italic(m[jkl]))
  )

p_3way
```

## Everything Together

```{r all-effects, fig.width=8, fig.height=10}
p_main / p_2way & theme(
  panel.grid.minor.x = element_blank(),
  panel.grid.minor.y = element_blank()
)

# p_main + p_2way + p_3way + plot_layout(ncol = 1)
```
